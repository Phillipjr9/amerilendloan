import { z } from "zod";

// Define validation schema for critical environment variables
const envSchema = z.object({
  // Core â€” required for the app to function at all
  DATABASE_URL: z.string().min(1, "DATABASE_URL is required"),
  JWT_SECRET: z.string().min(8, "JWT_SECRET must be at least 8 characters"),
  VITE_APP_ID: z.string().min(1, "VITE_APP_ID is required"),

  // OAuth
  OAUTH_SERVER_URL: z.string().optional().default(""),
  OWNER_OPEN_ID: z.string().optional().default(""),

  // Forge
  BUILT_IN_FORGE_API_URL: z.string().optional().default(""),
  BUILT_IN_FORGE_API_KEY: z.string().optional().default(""),

  // OpenAI
  OPENAI_API_KEY: z.string().optional().default(""),

  // Twilio (SMS)
  TWILIO_ACCOUNT_SID: z.string().optional().default(""),
  TWILIO_AUTH_TOKEN: z.string().optional().default(""),
  TWILIO_PHONE_NUMBER: z.string().optional().default(""),

  // SendGrid (email)
  SENDGRID_API_KEY: z.string().optional().default(""),
  EMAIL_TEST_MODE: z.string().optional().default("false"),

  // Supabase
  VITE_SUPABASE_URL: z.string().optional().default(""),
  VITE_SUPABASE_ANON_KEY: z.string().optional().default(""),

  // OAuth Social
  GOOGLE_CLIENT_ID: z.string().optional().default(""),
  GOOGLE_CLIENT_SECRET: z.string().optional().default(""),
  GITHUB_CLIENT_ID: z.string().optional().default(""),
  GITHUB_CLIENT_SECRET: z.string().optional().default(""),
  MICROSOFT_CLIENT_ID: z.string().optional().default(""),
  MICROSOFT_CLIENT_SECRET: z.string().optional().default(""),

  // Stripe
  STRIPE_SECRET_KEY: z.string().optional().default(""),
  STRIPE_PUBLISHABLE_KEY: z.string().optional().default(""),

  // Admin
  ADMIN_EMAIL: z.string().optional().default("admin@amerilendloan.com"),

  // Node env
  NODE_ENV: z.string().optional().default("development"),
});

// Parse and validate env vars at startup
function validateEnv() {
  const result = envSchema.safeParse(process.env);
  if (!result.success) {
    const errors = result.error.flatten().fieldErrors;
    const missing = Object.entries(errors)
      .map(([key, msgs]) => `  - ${key}: ${(msgs ?? []).join(", ")}`)
      .join("\n");
    console.error(`\n[env] Missing or invalid environment variables:\n${missing}\n`);
    if (process.env.NODE_ENV === "production") {
      process.exit(1);
    }
  }
  return result.success ? result.data : null;
}

const validated = validateEnv();

export const ENV = {
  appId: process.env.VITE_APP_ID ?? "",
  cookieSecret: process.env.JWT_SECRET ?? "",
  databaseUrl: process.env.DATABASE_URL ?? "",
  oAuthServerUrl: process.env.OAUTH_SERVER_URL ?? "",
  ownerOpenId: process.env.OWNER_OPEN_ID ?? "",
  isProduction: process.env.NODE_ENV === "production",
  forgeApiUrl: process.env.BUILT_IN_FORGE_API_URL ?? "",
  forgeApiKey: process.env.BUILT_IN_FORGE_API_KEY ?? "",
  openAiApiKey: process.env.OPENAI_API_KEY ?? "",
  twilioAccountSid: process.env.TWILIO_ACCOUNT_SID ?? "",
  twilioAuthToken: process.env.TWILIO_AUTH_TOKEN ?? "",
  twilioPhoneNumber: process.env.TWILIO_PHONE_NUMBER ?? "",
  sendGridApiKey: process.env.SENDGRID_API_KEY ?? "",
  emailTestMode: process.env.EMAIL_TEST_MODE === "true",
  supabaseUrl: process.env.VITE_SUPABASE_URL ?? "",
  supabaseAnonKey: process.env.VITE_SUPABASE_ANON_KEY ?? "",
  googleClientId: process.env.GOOGLE_CLIENT_ID ?? "",
  googleClientSecret: process.env.GOOGLE_CLIENT_SECRET ?? "",
  githubClientId: process.env.GITHUB_CLIENT_ID ?? "",
  githubClientSecret: process.env.GITHUB_CLIENT_SECRET ?? "",
  microsoftClientId: process.env.MICROSOFT_CLIENT_ID ?? "",
  microsoftClientSecret: process.env.MICROSOFT_CLIENT_SECRET ?? "",
  stripeSecretKey: process.env.STRIPE_SECRET_KEY ?? "",
  stripePublishableKey: process.env.STRIPE_PUBLISHABLE_KEY ?? "",
  adminEmail: process.env.ADMIN_EMAIL ?? "admin@amerilendloan.com",
};

export function getEnv() {
  return {
    GOOGLE_CLIENT_ID: ENV.googleClientId,
    GOOGLE_CLIENT_SECRET: ENV.googleClientSecret,
    GITHUB_CLIENT_ID: ENV.githubClientId,
    GITHUB_CLIENT_SECRET: ENV.githubClientSecret,
    MICROSOFT_CLIENT_ID: ENV.microsoftClientId,
    MICROSOFT_CLIENT_SECRET: ENV.microsoftClientSecret,
  };
}
